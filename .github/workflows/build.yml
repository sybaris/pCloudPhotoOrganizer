name: Build MAUI Apps

on:
  push:
    branches:
      - main
      - master
  pull_request:

env:
  DOTNET_VERSION: 9.0.x
  CONFIGURATION: Release
  SOLUTION_PATH: src/pCloudPhotoOrganizer/pCloudPhotoOrganizer.sln
  ANDROID_TFM: net9.0-android35.0
  WINDOWS_TFM: net9.0-windows10.0.19041.0
  DOTNET_NOLOGO: true
  DOTNET_CLI_TELEMETRY_OPTOUT: 1
  ANDROID_SDK_ROOT: /usr/local/lib/android/sdk

jobs:
  windows:
    name: Build Windows (MSIX/AppxBundle)
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Install MAUI workload
        run: dotnet workload install maui

      - name: Restore packages (Windows TFM)
        run: dotnet restore ${{ env.SOLUTION_PATH }} -p:TargetFramework=${{ env.WINDOWS_TFM }}

      - name: Publish Windows package
        run: dotnet publish ${{ env.SOLUTION_PATH }} -f ${{ env.WINDOWS_TFM }} -c ${{ env.CONFIGURATION }} -p:WindowsPackageType=msix -p:AppxPackageSigningEnabled=false

      - name: Upload Windows artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-msix
          if-no-files-found: error
          path: |
            src/pCloudPhotoOrganizer/bin/${{ env.CONFIGURATION }}/${{ env.WINDOWS_TFM }}/**/*.msix
            src/pCloudPhotoOrganizer/bin/${{ env.CONFIGURATION }}/${{ env.WINDOWS_TFM }}/**/*.appxbundle

  android:
    name: Build Android (APK + AAB)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: microsoft
          java-version: "17"

      - name: Install Android SDK components
        run: |
          yes | sudo ${ANDROID_SDK_ROOT}/cmdline-tools/latest/bin/sdkmanager "platforms;android-35" "platform-tools" "build-tools;35.0.0" "ndk;26.1.10909125"

      - name: Install MAUI Android workload
        run: dotnet workload install maui-android

      - name: Restore packages (Android TFM)
        run: dotnet restore ${{ env.SOLUTION_PATH }} -p:TargetFramework=${{ env.ANDROID_TFM }}

      - name: Publish Android APK
        run: dotnet publish ${{ env.SOLUTION_PATH }} -f ${{ env.ANDROID_TFM }} -c ${{ env.CONFIGURATION }} -p:AndroidPackageFormat=apk -p:AndroidSignPackage=false

      - name: Publish Android AAB
        run: dotnet publish ${{ env.SOLUTION_PATH }} -f ${{ env.ANDROID_TFM }} -c ${{ env.CONFIGURATION }} -p:AndroidPackageFormat=aab -p:AndroidSignPackage=false

      - name: Upload Android APK
        uses: actions/upload-artifact@v4
        with:
          name: android-apk
          if-no-files-found: error
          path: src/pCloudPhotoOrganizer/bin/${{ env.CONFIGURATION }}/${{ env.ANDROID_TFM }}/**/*.apk

      - name: Upload Android AAB
        uses: actions/upload-artifact@v4
        with:
          name: android-aab
          if-no-files-found: error
          path: src/pCloudPhotoOrganizer/bin/${{ env.CONFIGURATION }}/${{ env.ANDROID_TFM }}/**/*.aab
