name: Build MAUI Apps
permissions:
  contents: write

on:
  push:
    branches:
      - main
      - master
  pull_request:

env:
  DOTNET_VERSION: 9.0.x
  CONFIGURATION: Release
  SOLUTION_PATH: src/pCloudPhotoOrganizer/pCloudPhotoOrganizer.sln
  ANDROID_TFM: net9.0-android35.0
  WINDOWS_TFM: net9.0-windows10.0.19041.0
  DOTNET_NOLOGO: true
  DOTNET_CLI_TELEMETRY_OPTOUT: 1
  ANDROID_SDK_ROOT: /usr/local/lib/android/sdk
  PROJECT_PATH: src/pCloudPhotoOrganizer/pCloudPhotoOrganizer.csproj
  BUILD_NUMBER: ${{ github.run_number }}
  ANDROID_APK_NAME: pCloudPhotoOrganizer-beta.apk

jobs:
  windows:
    name: Build Windows (MSIX/AppxBundle)
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Inject build number metadata
        shell: pwsh
        run: |
          $content = @{ buildNumber = "${{ env.BUILD_NUMBER }}" } | ConvertTo-Json -Compress
          $path = "src/pCloudPhotoOrganizer/Resources/Raw/buildinfo.json"
          New-Item -ItemType File -Path $path -Force | Out-Null
          Set-Content -Path $path -Value $content -Encoding utf8

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Install MAUI workload
        run: dotnet workload install maui

      - name: Restore packages (Windows TFM)
        run: dotnet restore ${{ env.PROJECT_PATH  }} -p:TargetFramework=${{ env.WINDOWS_TFM }}

      - name: Publish Windows package
        run: dotnet publish ${{ env.PROJECT_PATH  }} -f ${{ env.WINDOWS_TFM }} -c ${{ env.CONFIGURATION }} -p:WindowsPackageType=MSIX -p:AppxPackageSigningEnabled=false

      - name: Upload Windows artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-msix
          if-no-files-found: error
          path: |
            src/pCloudPhotoOrganizer/bin/${{ env.CONFIGURATION }}/${{ env.WINDOWS_TFM }}/**/*.msix
            src/pCloudPhotoOrganizer/bin/${{ env.CONFIGURATION }}/${{ env.WINDOWS_TFM }}/**/*.appxbundle

  android:
    name: Build Android (APK + AAB)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Inject build number metadata
        shell: bash
        run: |
          cat <<EOF > src/pCloudPhotoOrganizer/Resources/Raw/buildinfo.json
          {"buildNumber":"${{ env.BUILD_NUMBER }}"
          }
          EOF

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: microsoft
          java-version: "17"

      - name: Install Android SDK components
        run: |
          yes | sudo ${ANDROID_SDK_ROOT}/cmdline-tools/latest/bin/sdkmanager "platforms;android-35" "platform-tools" "build-tools;35.0.0" "ndk;26.1.10909125"

      - name: Install MAUI Android workload
        run: dotnet workload install maui-android

      - name: Restore packages (Android TFM)
        run: dotnet restore ${{ env.PROJECT_PATH  }} -p:TargetFramework=${{ env.ANDROID_TFM }}

      - name: Publish Android APK
        run: |
          dotnet publish ${{ env.PROJECT_PATH }} \
            -f ${{ env.ANDROID_TFM }} \
            -c ${{ env.CONFIGURATION }} \
            -p:AndroidPackageFormat=apk \
            -p:AndroidSignPackage=false

      - name: Rename Android APK
        run: |
          APK_DIR="src/pCloudPhotoOrganizer/bin/${{ env.CONFIGURATION }}/${{ env.ANDROID_TFM }}/publish"
          ls -la "$APK_DIR"

          mv "$APK_DIR"/*.apk \
             "$APK_DIR/${{ env.ANDROID_APK_NAME }}"

      - name: Publish Android AAB
        run: dotnet publish ${{ env.PROJECT_PATH  }} -f ${{ env.ANDROID_TFM }} -c ${{ env.CONFIGURATION }} -p:AndroidPackageFormat=aab -p:AndroidSignPackage=false

      - name: Upload Android APK
        uses: actions/upload-artifact@v4
        with:
          name: com.companyname.pcloudphotoorganizer-apk
          if-no-files-found: error
          path: src/pCloudPhotoOrganizer/bin/${{ env.CONFIGURATION }}/${{ env.ANDROID_TFM }}/publish/*.apk

      - name: Upload Android AAB
        uses: actions/upload-artifact@v4
        with:
          name: android-aab
          if-no-files-found: error
          path: src/pCloudPhotoOrganizer/bin/${{ env.CONFIGURATION }}/${{ env.ANDROID_TFM }}/publish/*.aab

      - name: Delete previous APK from beta release
        uses: mknejp/delete-release-assets@v1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          tag: beta
          assets: "*.apk"
